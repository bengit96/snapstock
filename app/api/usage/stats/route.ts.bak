import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { db } from '@/lib/db/client'
import { chartAnalyses, users } from '@/lib/db/schema'
import { eq, and, gte, desc } from 'drizzle-orm'

export async function GET(request: NextRequest) {
  try {
    const session = await auth()

    if (!session || !session.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Use db directly

    // Get user info for free trial stats
    const userResult = await dbClient
      .select({
        freeAnalysesUsed: users.freeAnalysesUsed,
        freeAnalysesLimit: users.freeAnalysesLimit,
        subscriptionStatus: users.subscriptionStatus,
      })
      .from(users)
      .where(eq(users.id, session.user.id))
      .limit(1)

    const user = userResult[0]

    // Get total analyses
    const totalAnalyses = await dbClient
      .select()
      .from(chartAnalyses)
      .where(eq(chartAnalyses.userId, session.user.id))

    // Get this month's analyses
    const thisMonthStart = new Date()
    thisMonthStart.setDate(1)
    thisMonthStart.setHours(0, 0, 0, 0)

    const thisMonth = await dbClient
      .select()
      .from(chartAnalyses)
      .where(
        and(
          eq(chartAnalyses.userId, session.user.id),
          gte(chartAnalyses.createdAt, thisMonthStart)
        )
      )

    // Get this week's analyses
    const thisWeekStart = new Date()
    thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay())
    thisWeekStart.setHours(0, 0, 0, 0)

    const thisWeek = await dbClient
      .select()
      .from(chartAnalyses)
      .where(
        and(
          eq(chartAnalyses.userId, session.user.id),
          gte(chartAnalyses.createdAt, thisWeekStart)
        )
      )

    // Get recent analyses (last 10)
    const recentAnalyses = await dbClient
      .select({
        id: chartAnalyses.id,
        stockSymbol: chartAnalyses.stockSymbol,
        grade: chartAnalyses.grade,
        createdAt: chartAnalyses.createdAt,
      })
      .from(chartAnalyses)
      .where(eq(chartAnalyses.userId, session.user.id))
      .orderBy(desc(chartAnalyses.createdAt))
      .limit(10)

    return NextResponse.json({
      totalAnalyses: totalAnalyses.length,
      thisMonth: thisMonth.length,
      thisWeek: thisWeek.length,
      recentAnalyses: recentAnalyses.map((a) => ({
        ...a,
        createdAt: a.createdAt.toISOString(),
      })),
      // Include free trial stats if user is on free plan
      ...((!user.subscriptionStatus || user.subscriptionStatus !== 'active') && {
        freeAnalysesUsed: user.freeAnalysesUsed,
        freeAnalysesLimit: user.freeAnalysesLimit,
      }),
    })
  } catch (error) {
    console.error('Error fetching usage stats:', error)
    return NextResponse.json(
      { error: 'Failed to fetch usage stats' },
      { status: 500 }
    )
  }
}
